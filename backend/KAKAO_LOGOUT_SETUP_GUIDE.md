# ์นด์นด์ค ๋ก๊ทธ์์ ์ค์ ๊ฐ์ด๋

## ๐ ๋ฌธ์ ๋ถ์

๋ก๊ทธ์์ ํ ๋ค์ ๋ก๊ทธ์ธํ๋ฉด ์๋์ผ๋ก ์ด์ ๊ณ์์ผ๋ก ๋ก๊ทธ์ธ๋๋ ์ด์:

1. **์นด์นด์ค ์ธ์์ด ์์ง๋จ**: ๋ฐฑ์๋์์ ๋ก๊ทธ์์ํด๋ ์นด์นด์ค ์ธก ์ธ์์ด ์์ง๋ฉ๋๋ค.
2. **์นด์นด์ค ๋ก๊ทธ์์ URL ๋ฏธ์ฌ์ฉ**: ํ๋กํธ์๋์์ ์นด์นด์ค ๋ก๊ทธ์์ URL๋ก ๋ฆฌ๋ค์ด๋ํธํ์ง ์์์ต๋๋ค.
3. **๋ก๊ทธ์์ ๋ฆฌ๋ค์ด๋ํธ URI ๋ฏธ๋ฑ๋ก**: ์นด์นด์ค ๊ฐ๋ฐ์ ์ฝ์์ ๋ก๊ทธ์์ ๋ฆฌ๋ค์ด๋ํธ URI๊ฐ ๋ฑ๋ก๋์ง ์์์ต๋๋ค.

---

## โ ํด๊ฒฐ ๋ฐฉ๋ฒ

### 1๋จ๊ณ: ์นด์นด์ค ๊ฐ๋ฐ์ ์ฝ์์ ๋ก๊ทธ์์ ๋ฆฌ๋ค์ด๋ํธ URI ๋ฑ๋ก (ํ์)

#### ์ค์ ๋ฐฉ๋ฒ

1. [์นด์นด์ค ๊ฐ๋ฐ์ ์ฝ์](https://developers.kakao.com/) ์์
2. **๋ด ์ํ๋ฆฌ์ผ์ด์** โ ์ํ๋ฆฌ์ผ์ด์ ์ํ
3. **์ํ ์ค์** โ **์นด์นด์ค ๋ก๊ทธ์ธ** โ **๋ก๊ทธ์์ ๋ฆฌ๋ค์ด๋ํธ URI** ์น์
4. **๋ฆฌ๋ค์ด๋ํธ URI ๋ฑ๋ก** ๋ฒํผ ํด๋ฆญ
5. ๋ค์ URI ์ถ๊ฐ:

#### ๋ก์ปฌ ๊ฐ๋ฐ ํ๊ฒฝ
```
http://localhost:3000
```

#### ํ๋ก๋์ ํ๊ฒฝ
```
https://your-frontend-domain.com
```

**โ๏ธ ์ค์**: 
- ๋ก๊ทธ์์ ๋ฆฌ๋ค์ด๋ํธ URI๋ **ํ๋กํธ์๋ URL**์๋๋ค (๋ฐฑ์๋ URL์ด ์๋!)
- ์ต๋ 10๊ฐ๊น์ง ๋ฑ๋ก ๊ฐ๋ฅ
- ๋ก์ปฌ๊ณผ ํ๋ก๋์ ๋ชจ๋ ๋ฑ๋ก ๊ถ์ฅ

---

### 2๋จ๊ณ: ๋ก๊ทธ์์ ๋ก์ง ์์

ํ์ฌ ์ฝ๋๋ ์นด์นด์ค ๋ก๊ทธ์์ URL์ JSON์ผ๋ก ๋ฐํํ์ง๋ง, ๋ ๋์ ๋ฐฉ๋ฒ์ **์ง์ ๋ฆฌ๋ค์ด๋ํธ**ํ๋ ๊ฒ์๋๋ค.

#### ์ต์ A: ๋ฐฑ์๋์์ ์ง์ ๋ฆฌ๋ค์ด๋ํธ (๊ถ์ฅ)

๋ก๊ทธ์์ ์ ์นด์นด์ค ๋ก๊ทธ์์ URL๋ก ์ง์ ๋ฆฌ๋ค์ด๋ํธ:

```typescript
@Post('logout')
async logout(@Req() req: Request, @Res() res: Response) {
  const user = req.user as any;
  
  // DB์์ Refresh Token ์๊ฑฐ
  await this.authService.logout(user.id);
  
  // ์ฟํค ์๊ฑฐ
  res.clearCookie('access_token', { ... });
  res.clearCookie('refresh_token', { ... });
  
  // ์นด์นด์ค ๋ก๊ทธ์์ URL๋ก ์ง์ ๋ฆฌ๋ค์ด๋ํธ
  const clientID = process.env.KAKAO_CLIENT_ID || '';
  const frontendUrl = process.env.FRONTEND_URL || 'http://localhost:3000';
  const kakaoLogoutUrl = `https://kauth.kakao.com/oauth/logout?client_id=${clientID}&logout_redirect_uri=${encodeURIComponent(frontendUrl)}`;
  
  res.redirect(kakaoLogoutUrl);
}
```

#### ์ต์ B: ํ๋กํธ์๋์์ ๋ฆฌ๋ค์ด๋ํธ (ํ์ฌ ๋ฐฉ์)

ํ์ฌ ์ฝ๋๋ ์นด์นด์ค ๋ก๊ทธ์์ URL์ ๋ฐํํ๋ฏ๋ก, ํ๋กํธ์๋์์ ์ฒ๋ฆฌ:

```typescript
// ํ๋กํธ์๋ ๋ก๊ทธ์์ ํจ์
const handleLogout = async () => {
  const response = await fetch('http://localhost:3001/api/auth/logout', {
    method: 'POST',
    credentials: 'include',
  });
  
  const data = await response.json();
  
  // ์นด์นด์ค ๋ก๊ทธ์์ URL๋ก ๋ฆฌ๋ค์ด๋ํธ
  if (data.kakaoLogoutUrl) {
    window.location.href = data.kakaoLogoutUrl;
  }
};
```

---

### 3๋จ๊ณ: `prompt=login` ํ๋ผ๋ฏธํฐ ํ์ธ

`kakao.strategy.ts`์ `prompt=login`์ด ์ค์๋์ด ์๋์ง ํ์ธ:

```typescript
super({
  clientID,
  clientSecret,
  callbackURL: `${backendUrl}/api/auth/kakao/callback`,
  authorizationParams: {
    prompt: 'login', // ํญ์ ๋ก๊ทธ์ธ ํ๋ฉด ํ์
  },
});
```

**โ๏ธ ์ฃผ์**: 
- `prompt=login`๋ง์ผ๋ก๋ ๋ถ์กฑํ ์ ์์ต๋๋ค.
- ์นด์นด์ค ์ธ์์ ์์ํ ์ข๋ฃํ๋ค๋ฉด ์นด์นด์ค ๋ก๊ทธ์์ URL์ ์ฌ์ฉํด์ผ ํฉ๋๋ค.

---

## ๐ ์์ฒด ํ๋ก์ฐ

### ์ฌ๋ฐ๋ฅธ ๋ก๊ทธ์์ ํ๋ก์ฐ

```
1. ์ฌ์ฉ์๊ฐ ๋ก๊ทธ์์ ๋ฒํผ ํด๋ฆญ
   โ
2. ํ๋กํธ์๋ โ ๋ฐฑ์๋: POST /api/auth/logout
   โ
3. ๋ฐฑ์๋:
   - DB์์ Refresh Token ์๊ฑฐ
   - ์ฟํค ์๊ฑฐ
   - ์นด์นด์ค ๋ก๊ทธ์์ URL ๋ฐํ ๋๋ ๋ฆฌ๋ค์ด๋ํธ
   โ
4. ํ๋กํธ์๋ โ ์นด์นด์ค: ์นด์นด์ค ๋ก๊ทธ์์ URL๋ก ๋ฆฌ๋ค์ด๋ํธ
   โ
5. ์นด์นด์ค:
   - ์นด์นด์ค ์ธ์ ์ข๋ฃ
   - ํ๋กํธ์๋๋ก ๋ฆฌ๋ค์ด๋ํธ (๋ก๊ทธ์์ ๋ฆฌ๋ค์ด๋ํธ URI)
   โ
6. ํ๋กํธ์๋: ๋ก๊ทธ์ธ ํ์ด์ง๋ก ์ด๋
```

---

## ๐ ์ฒดํฌ๋ฆฌ์คํธ

### ์นด์นด์ค ๊ฐ๋ฐ์ ์ฝ์ ์ค์

- [ ] ๋ก๊ทธ์์ ๋ฆฌ๋ค์ด๋ํธ URI ๋ฑ๋ก:
  - [ ] `http://localhost:3000` (๋ก์ปฌ)
  - [ ] `https://your-frontend-domain.com` (ํ๋ก๋์)

### ์ฝ๋ ํ์ธ

- [ ] `kakao.strategy.ts`์ `prompt: 'login'` ์ค์ ํ์ธ
- [ ] `auth.controller.ts`์ `logout` ๋ฉ์๋์์ ์นด์นด์ค ๋ก๊ทธ์์ URL ์์ฑ ํ์ธ
- [ ] ํ๊ฒฝ ๋ณ์ `KAKAO_CLIENT_ID`, `FRONTEND_URL` ์ค์ ํ์ธ

### ํ์คํธ

- [ ] ๋ก๊ทธ์ธ โ ๋ก๊ทธ์์ โ ๋ค์ ๋ก๊ทธ์ธ
- [ ] ๋ก๊ทธ์ธ ํ๋ฉด์ด ํ์๋๋์ง ํ์ธ
- [ ] ์๋ ๋ก๊ทธ์ธ์ด ๋์ง ์๋์ง ํ์ธ

---

## ๐จ ๋ฌธ์ ํด๊ฒฐ

### ๋ฌธ์ 1: ์ฌ์ํ ์๋ ๋ก๊ทธ์ธ๋จ

**์์ธ**: ์นด์นด์ค ๋ก๊ทธ์์ URL๋ก ๋ฆฌ๋ค์ด๋ํธํ์ง ์์

**ํด๊ฒฐ**:
1. ํ๋กํธ์๋์์ ๋ก๊ทธ์์ API ํธ์ถ ํ `kakaoLogoutUrl`๋ก ๋ฆฌ๋ค์ด๋ํธ
2. ๋๋ ๋ฐฑ์๋์์ ์ง์ ๋ฆฌ๋ค์ด๋ํธํ๋๋ก ์์

### ๋ฌธ์ 2: ์นด์นด์ค ๋ก๊ทธ์์ ํ ์๋ฌ ๋ฐ์

**์์ธ**: ๋ก๊ทธ์์ ๋ฆฌ๋ค์ด๋ํธ URI๊ฐ ๋ฑ๋ก๋์ง ์์

**ํด๊ฒฐ**: ์นด์นด์ค ๊ฐ๋ฐ์ ์ฝ์์ ๋ก๊ทธ์์ ๋ฆฌ๋ค์ด๋ํธ URI ๋ฑ๋ก

### ๋ฌธ์ 3: `prompt=login`์ด ์๋ํ์ง ์์

**์์ธ**: `passport-kakao`์์ `authorizationParams`๊ฐ ์๋๋ก ์๋ฌ๋์ง ์์ ์ ์์

**ํด๊ฒฐ**: 
1. ์นด์นด์ค ๋ก๊ทธ์์ URL ์ฌ์ฉ (๋ ํ์คํ ๋ฐฉ๋ฒ)
2. ๋๋ ์นด์นด์ค ๋ก๊ทธ์ธ URL์ ์ง์ ์ฟผ๋ฆฌ ํ๋ผ๋ฏธํฐ ์ถ๊ฐ

---

## ๐ก ๊ถ์ฅ ์ฌํญ

1. **๋ฐฑ์๋์์ ์ง์ ๋ฆฌ๋ค์ด๋ํธ** (์ต์ A)๋ฅผ ๊ถ์ฅํฉ๋๋ค.
   - ํ๋กํธ์๋์์ ์ถ๊ฐ ์์ ๋ถํ์
   - ๋ ํ์คํ ๋ก๊ทธ์์ ์ฒ๋ฆฌ

2. **์นด์นด์ค ๊ฐ๋ฐ์ ์ฝ์ ์ค์ ํ์**:
   - ๋ก๊ทธ์์ ๋ฆฌ๋ค์ด๋ํธ URI ๋ฑ๋ก
   - ๋ก์ปฌ๊ณผ ํ๋ก๋์ ๋ชจ๋ ๋ฑ๋ก

3. **ํ์คํธ**:
   - ๋ก๊ทธ์์ ํ ๋ธ๋ผ์ฐ์ ๊ฐ๋ฐ์ ๋๊ตฌ์์ ์นด์นด์ค ์ฟํค ํ์ธ
   - ๋ค์ ๋ก๊ทธ์ธ ์ ๋ก๊ทธ์ธ ํ๋ฉด์ด ํ์๋๋์ง ํ์ธ

---

์ด ๊ฐ์ด๋๋ฅผ ์ฐธ๊ณํ์ฌ ์นด์นด์ค ๋ก๊ทธ์์์ ์ฌ๋ฐ๋ฅด๊ฒ ์ค์ํ์ธ์! ๐

